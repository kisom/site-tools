#!/bin/sh
# .:[ rawk - rage against web frameworks ]:.
# 
# generates a static content from a tree of markdown files and other content
# originally written by 4096R/B7B720D6  "Kyle Isom <coder@kyleisom.net>"
# based on the suckless webframework (sw) by nibblesec
# 
# released as public domain software - for curiosity's sake, i'd be interested 
# in hearing if you take this and tinker with it, though you are far from 
# obligated to do so.

CONF_FILE="rawkrc"
SRC_DIR="$1"

usage () {
    echo "usage: $0 <source dir>"
    exit 0
}

rawk_header () {
    HEADER=""
    PAGE_TITLE="$(basename $1 | sed -e 's/^\(..*\)\...*$/\1/')" # get pagename
    CSS_DATA="$(cat $STYLESHEET)"

    echo $(cat ${HDR_TPL} | sed -e "s/\$\{TITLE\}/$SITE_TITLE/"         \
                                -e "s/\$\{SUBTITLE\}/$SITE_SUBTITLE "   \
				-e "s/\$\{STYLE\}/$CSS_DATA/"           \
      			            s/\$\{PAGETITLE\}/$PAGE_TITLE"
    ")
}

rawk_submenu () {
    FC=""               # filter chain
    FILE_LIST=""
    echo "<div id=\"side-bar\">"

    for filter in $BL
    do
        FC="$FC | grep -v '$filter'"
    done

    FILE_LIST=$(eval ls -1 $(dirname $CUR) $FC | sort | xargs)
    for FILE in $FILE_LIST
    do
<<<<<<< HEAD
        SUBMENU="$SUBMENU<a href=\"$(basename $FILE)\">"
        FILE="$(basename $FILE | sed -e 's/(.\+)\.[A-Za-z0-9]\+/\1/')"
        SUBMENU="$SUBMENU$FILE</a> "
    done
=======
        echo "$SUBMENU<a href=\"$(basename $FILE)\">"
        echo "$(basename $FILE | sed -e 's/(.\+)\.[A-Za-z0-9]\+/\1/')</a> \n"
    done
    echo 
>>>>>>> 84ec1798967b80ec71e7dbdd4833d07a4f250e56
}

rawk_page () {
    # clear out vars
    PAGE=""
    FOOTER=""

<<<<<<< HEAD
    # build page
    build_header
    build_submenu
    PAGE="$HEADER$MENU"
=======
    rawk_header $1
    rawk_submenu
>>>>>>> 84ec1798967b80ec71e7dbdd4833d07a4f250e56
    
    echo $($MDPARSER $1)

    rawk_footer

<<<<<<< HEAD
    PAGE="$PAGE$FOOTER"

    echo $PAGE > $CUR_FILE
    
=======
>>>>>>> 84ec1798967b80ec71e7dbdd4833d07a4f250e56
}

# source config file and check valid targets and source dirs
. ./$CONF_FILE
if [ -z ${SRC_DIR} ]; then
    usage
fi

if [ -z ${TARGET} ]; then
    TARGET="$(pwd)/$(basename ${SRC_DIR}).build"
fi

# copy over target dir
cp -r ${SRC_DIR} ${TARGET}
cd ${TARGET}


# here's where we need to load in the list of files
# and convert md->html
for SRC_F in $(find ${TARGET} -iname \*.md -echo | xargs)
do
    rawk_page 

